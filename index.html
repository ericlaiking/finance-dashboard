<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½å¸‚å ´å„€è¡¨æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .dashboard-container { max-width: 1200px; margin: 30px auto; }
        
        .card { 
            border: none; border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
            transition: all 0.3s ease; height: 100%; 
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        
        .metric-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .metric-title { font-size: 0.85rem; color: #8898aa; font-weight: 600; text-transform: uppercase; }
        .metric-value { font-size: 2.5rem; font-weight: 700; line-height: 1; margin-bottom: 10px; }
        
        .gauge-container { height: 6px; background: #e9ecef; border-radius: 4px; margin-bottom: 15px; overflow: hidden; }
        .gauge-fill { height: 100%; border-radius: 4px; transition: width 1s ease-in-out, background-color 0.5s; }
        
        .chart-wrapper { height: 150px; width: 100%; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .chart-controls { display: flex; justify-content: flex-end; gap: 4px; margin-top: 5px; }
        .btn-time { font-size: 0.7rem; padding: 2px 10px; border-radius: 15px; border: 1px solid #dee2e6; background: white; color: #6c757d; }
        .btn-time.active { background: #344767; color: white; border-color: #344767; }

        .section-title { font-size: 1.2rem; font-weight: bold; margin: 30px 0 15px 0; border-left: 5px solid #344767; padding-left: 10px; }
    </style>
</head>
<body>

<div class="container dashboard-container">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 class="fw-bold text-dark">ğŸ“Š æŠ•è³‡æ±ºç­–æˆ°æƒ…å®¤</h2>
            <p class="text-muted mb-0">åŸºæœ¬é¢ Â· æƒ…ç·’é¢ Â· è³‡é‡‘é¢</p>
        </div>
        <div class="text-end">
            <small class="text-muted d-block">Data Updated</small>
            <span id="last-update" class="fw-bold">è¼‰å…¥ä¸­...</span>
        </div>
    </div>

    <div class="section-title">å¸‚å ´ç†±åº¦ (Market Heat)</div>
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">CNN ææ‡¼è²ªå©ª</span>
                    <span class="badge bg-light text-dark" id="cnn-badge">--</span>
                </div>
                <div class="metric-value" id="cnn-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="cnn-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartCNN"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">å°ç©é›» æœ¬ç›Šæ¯”</span>
                    <span class="badge bg-light text-dark" id="pe-badge">--</span>
                </div>
                <div class="metric-value" id="pe-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="pe-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartPE"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">æ™¯æ°£å°ç­–ä¿¡è™Ÿ</span>
                    <span class="badge bg-light text-dark" id="biz-badge">--</span>
                </div>
                <div class="metric-value" id="biz-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="biz-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartBiz"></canvas></div>
            </div>
        </div>
    </div>

    <div class="section-title">é¢¨éšªèˆ‡è³‡é‡‘ (Risk & Flow)</div>
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-time active" onclick="updateTimeRange('30d', this)">30å¤©</button>
        <button class="btn btn-time" onclick="updateTimeRange('90d', this)">90å¤©</button>
        <button class="btn btn-time" onclick="updateTimeRange('all', this)">å…¨éƒ¨</button>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">VIX ææ…ŒæŒ‡æ•¸</span>
                    <span class="badge bg-light text-dark" id="vix-badge">--</span>
                </div>
                <div class="metric-value" id="vix-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="vix-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartVIX"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">ç¾åœ‹ 10å¹´å‚µæ®–åˆ©ç‡</span>
                    <span class="badge bg-light text-dark" id="bond-badge">--</span>
                </div>
                <div class="metric-value" id="bond-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="bond-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartBond"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">ç¾å…ƒ/å°å¹£ åŒ¯ç‡</span>
                    <span class="badge bg-light text-dark" id="usd-badge">--</span>
                </div>
                <div class="metric-value" id="usd-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="usd-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartUSD"></canvas></div>
            </div>
        </div>
    </div>
</div>

<script>
    let rawData = [];
    let charts = {};
    const COLORS = { hot: '#ff3333', warm: '#ff8833', neutral: '#888888', cool: '#33aaff', cold: '#00cc66' };

    // ç‹€æ…‹åˆ¤æ–·é‚è¼¯ (æ ¸å¿ƒå¤§è…¦)
    function getStatus(value, type) {
        let pct = 50;
        if (type === 'cnn') {
            if (value >= 75) return { color: COLORS.hot, text: 'æ¥µåº¦è²ªå©ª' };
            if (value <= 25) return { color: COLORS.cold, text: 'æ¥µåº¦ææ‡¼' };
            return { color: COLORS.warm, text: 'ä¸­ç«‹' };
        } 
        if (type === 'pe') {
            // PE > 25 æ˜‚è²´(ç´…)
            return { color: value >= 25 ? COLORS.hot : (value <= 15 ? COLORS.cold : COLORS.neutral), text: value >= 25 ? 'æ˜‚è²´' : 'åˆç†' };
        }
        if (type === 'vix') {
            // VIX < 15 éåº¦å®‰é€¸(ç´…/è²ªå©ª), VIX > 25 ææ…Œ(ç¶ /è²·é»)
            let color = value < 15 ? COLORS.hot : (value > 25 ? COLORS.cold : COLORS.neutral);
            let text = value < 15 ? 'å®‰é€¸(è­¦)' : (value > 25 ? 'ææ…Œ(è²·)' : 'æ­£å¸¸');
            return { color: color, text: text };
        }
        if (type === 'bond') {
            // æ®–åˆ©ç‡ > 4.5% å£“åŠ›å¤§
            return { color: value >= 4.5 ? COLORS.hot : COLORS.neutral, text: value + '%' };
        }
        if (type === 'usd') {
            // åŒ¯ç‡ > 32.5 å¤–è³‡æµå‡º(ç´…), < 30 å¼·å‹¢(ç¶ )
            return { color: value >= 32.5 ? COLORS.hot : (value < 30 ? COLORS.cold : COLORS.neutral), text: value };
        }
        return { color: COLORS.neutral, text: '' };
    }

    function initChart(ctxId, color) {
        return new Chart(document.getElementById(ctxId).getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: color, borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: color + '10' }]},
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { position: 'right', grid: { display: false } } } }
        });
    }

    async function loadData() {
        try {
            const res = await fetch('./data/history.json?t=' + Date.now());
            rawData = await res.json();
            rawData.sort((a, b) => new Date(a.date.replace(/-/g, '/')) - new Date(b.date.replace(/-/g, '/')));
            
            updateDashboard(rawData[rawData.length - 1]);
            
            // åˆå§‹åŒ–6å€‹åœ–è¡¨
            charts.cnn = initChart('chartCNN', COLORS.warm);
            charts.pe = initChart('chartPE', COLORS.hot);
            charts.biz = initChart('chartBiz', COLORS.cold);
            charts.vix = initChart('chartVIX', COLORS.neutral); // VIX ç”¨ç°è‰²æˆ–ç‰¹æ®Šè‰²
            charts.bond = initChart('chartBond', '#000000'); // ç¾å‚µç”¨é»‘è‰²
            charts.usd = initChart('chartUSD', COLORS.cool); // åŒ¯ç‡ç”¨è—è‰²

            updateTimeRange('30d', null);
        } catch (e) { document.getElementById('last-update').innerText = "è®€å–å¤±æ•—"; console.error(e); }
    }

    function updateDashboard(latest) {
        document.getElementById('last-update').innerText = latest.date;
        
        // æ›´æ–°æ•¸å€¼å¡ç‰‡ Helper
        const updateCard = (id, val, type) => {
            const stat = getStatus(val, type);
            const elVal = document.getElementById(id + '-val');
            elVal.innerText = val;
            elVal.style.color = stat.color;
            document.getElementById(id + '-badge').innerText = stat.text;
            document.getElementById(id + '-bar').style.width = '100%'; // ç°¡åŒ– barï¼Œç›´æ¥æ»¿æ¢é¡¯ç¤ºé¡è‰²
            document.getElementById(id + '-bar').style.backgroundColor = stat.color;
        };

        updateCard('cnn', latest.cnn_score, 'cnn');
        updateCard('pe', latest.tw_pe, 'pe');
        updateCard('biz', latest.biz_score, 'biz');
        
        // æ–°æŒ‡æ¨™
        updateCard('vix', latest.vix || 0, 'vix');
        updateCard('bond', latest.us_10y || 0, 'bond');
        updateCard('usd', latest.usd_twd || 0, 'usd');
    }

    window.updateTimeRange = function(range, btn) {
        if (btn) {
            document.querySelectorAll('.btn-time').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        if (!rawData.length) return;
        
        const now = new Date();
        let cutoff = new Date();
        if (range === '30d') cutoff.setDate(now.getDate() - 30);
        else if (range === '90d') cutoff.setDate(now.getDate() - 90);
        else cutoff = new Date('2000-01-01');

        const data = rawData.filter(d => new Date(d.date.replace(/-/g, '/')) >= cutoff);
        const labels = data.map(d => d.date.substring(5, 10)); // MM-DD

        const update = (chart, key) => {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data.map(d => d[key] || 0);
            chart.update();
        };

        update(charts.cnn, 'cnn_score');
        update(charts.pe, 'tw_pe');
        update(charts.biz, 'biz_score');
        update(charts.vix, 'vix');
        update(charts.bond, 'us_10y');
        update(charts.usd, 'usd_twd');
    }

    loadData();
</script>

</body>
</html>
