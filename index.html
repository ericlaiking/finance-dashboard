<script>
    let rawData = [];
    let charts = {};

    // 顏色定義
    const COLORS = {
        hot: '#ff3333', warm: '#ff8833', neutral: '#888888', cool: '#33aaff', cold: '#00cc66'
    };

    // 取得顏色與狀態文字
    function getStatus(value, type) {
        if (type === 'cnn') {
            if (value >= 75) return { color: COLORS.hot, text: '極度貪婪', pct: value };
            if (value >= 55) return { color: COLORS.warm, text: '貪婪', pct: value };
            if (value >= 45) return { color: COLORS.neutral, text: '中立', pct: value };
            if (value >= 25) return { color: COLORS.cool, text: '恐懼', pct: value };
            return { color: COLORS.cold, text: '極度恐懼', pct: value };
        } 
        else if (type === 'pe') {
            let pct = Math.min(100, Math.max(0, (value - 10) * 5)); 
            if (value >= 25) return { color: COLORS.hot, text: '昂貴', pct: pct };
            if (value >= 20) return { color: COLORS.warm, text: '偏高', pct: pct };
            if (value >= 15) return { color: COLORS.neutral, text: '合理', pct: pct };
            return { color: COLORS.cold, text: '便宜', pct: pct };
        }
        else if (type === 'biz') {
            let pct = (value / 45) * 100;
            if (value >= 38) return { color: COLORS.hot, text: '紅燈 (過熱)', pct: pct };
            if (value >= 32) return { color: COLORS.warm, text: '黃紅燈', pct: pct };
            if (value >= 23) return { color: COLORS.cold, text: '綠燈 (穩定)', pct: pct }; 
            if (value >= 17) return { color: COLORS.cool, text: '黃藍燈', pct: pct };
            return { color: COLORS.cool, text: '藍燈 (低迷)', pct: pct };
        }
    }

    function initChart(ctxId, label, color) {
        const ctx = document.getElementById(ctxId).getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ 
                label: label, 
                data: [], 
                borderColor: color, 
                borderWidth: 2, 
                pointRadius: 0, 
                fill: true,
                backgroundColor: color + '10' 
            }]},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                scales: { 
                    x: { display: false }, 
                    y: { position: 'right', grid: { display: false } } 
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            }
        });
    }

    async function loadData() {
        try {
            // 加上時間戳記避免快取
            const response = await fetch('./data/history.json?t=' + Date.now());
            
            // 如果抓不到檔案，直接丟出錯誤
            if (!response.ok) throw new Error("File not found");

            rawData = await response.json();
            
            // 確保資料按時間排序 (處理新舊日期格式相容性)
            rawData.sort((a, b) => new Date(a.date.replace(/-/g, '/')) - new Date(b.date.replace(/-/g, '/')));

            // 更新最新數值面板
            if (rawData.length > 0) {
                updateDashboard(rawData[rawData.length - 1]);
            }

            // 初始化圖表物件
            charts.cnn = initChart('chartCNN', 'CNN Index', COLORS.warm);
            charts.pe = initChart('chartPE', 'PE Ratio', COLORS.hot);
            charts.biz = initChart('chartBiz', 'Signal', COLORS.cold);

            // 預設顯示 7 天 (這裡不會再報錯了)
            updateTimeRange('7d');

        } catch (e) {
            console.error("Data Load Error", e);
            document.getElementById('last-update').innerText = "讀取失敗";
        }
    }

    function updateDashboard(latest) {
        document.getElementById('last-update').innerText = latest.date;

        const cnnStat = getStatus(latest.cnn_score, 'cnn');
        document.getElementById('cnn-val').innerText = latest.cnn_score;
        document.getElementById('cnn-val').style.color = cnnStat.color;
        document.getElementById('cnn-badge').innerText = cnnStat.text;
        document.getElementById('cnn-bar').style.width = cnnStat.pct + '%';
        document.getElementById('cnn-bar').style.backgroundColor = cnnStat.color;

        const peStat = getStatus(latest.tw_pe, 'pe');
        document.getElementById('pe-val').innerText = latest.tw_pe;
        document.getElementById('pe-val').style.color = peStat.color;
        document.getElementById('pe-badge').innerText = peStat.text;
        document.getElementById('pe-bar').style.width = peStat.pct + '%';
        document.getElementById('pe-bar').style.backgroundColor = peStat.color;

        const bizStat = getStatus(latest.biz_score, 'biz');
        document.getElementById('biz-val').innerText = latest.biz_score;
        document.getElementById('biz-val').style.color = bizStat.color;
        document.getElementById('biz-badge').innerText = bizStat.text;
        document.getElementById('biz-bar').style.width = bizStat.pct + '%';
        document.getElementById('biz-bar').style.backgroundColor = bizStat.color;
    }

    // 修正後的切換邏輯
    window.updateTimeRange = function(range) {
        // --- 修正重點：檢查有沒有 event 存在 ---
        // 只有當使用者「親自點擊」時，才去切換按鈕的 Active 樣式
        // 如果是程式自動執行(初始化)，就跳過這段，避免報錯
        if (typeof event !== 'undefined' && event && event.target) {
            document.querySelectorAll('.btn-time').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }
        // ------------------------------------

        let sliceCount = 0;
        if (range === '7d') sliceCount = 24 * 7;
        else if (range === '30d') sliceCount = 24 * 30;
        else sliceCount = rawData.length;

        const filteredData = rawData.slice(-sliceCount);
        // 簡化日期標籤，只顯示 MM/DD
        const labels = filteredData.map(d => d.date.substring(5, 16)); 

        updateChartData(charts.cnn, labels, filteredData.map(d => d.cnn_score));
        updateChartData(charts.pe, labels, filteredData.map(d => d.tw_pe));
        updateChartData(charts.biz, labels, filteredData.map(d => d.biz_score));
    }

    function updateChartData(chart, labels, data) {
        if (!chart) return; // 防呆
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
    }

    loadData();
</script>
