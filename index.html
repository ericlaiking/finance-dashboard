<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>投資決策戰情室</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --ios-blur: saturate(180%) blur(20px);
            --ios-bg: rgba(255, 255, 255, 0.75);
            --card-radius: 20px;
        }

        body { 
            background-color: #f2f2f7; /* iOS 淺灰背景 */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 120px; /* 預留底部懸浮空間 */
        }
        
        .dashboard-container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        /* 卡片設計 */
        .card { 
            border: none; 
            border-radius: var(--card-radius); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
            transition: transform 0.2s; 
            background: white;
            height: 100%;
        }
        .card:active { transform: scale(0.98); }
        
        .metric-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .metric-title { font-size: 0.8rem; color: #8e8e93; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-badge { font-size: 0.7rem; padding: 4px 8px; border-radius: 8px; font-weight: 700; color: white; }
        .metric-value { font-size: 2.2rem; font-weight: 700; line-height: 1.1; margin: 5px 0 15px 0; letter-spacing: -0.5px; color: #1c1c1e; }
        
        .gauge-container { height: 6px; background: #e5e5ea; border-radius: 3px; margin-bottom: 15px; overflow: hidden; }
        .gauge-fill { height: 100%; border-radius: 3px; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.5s; }
        
        .chart-wrapper { height: 120px; width: 100%; }
        
        .section-title { 
            font-size: 1.3rem; font-weight: 700; color: #1c1c1e; 
            margin: 30px 0 15px 0; letter-spacing: -0.5px;
        }

        /* iOS 風格懸浮控制列 (修正為絕對置中與毛玻璃效果) */
        .floating-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: var(--ios-bg);
            backdrop-filter: var(--ios-blur);
            -webkit-backdrop-filter: var(--ios-blur);
            padding: 8px;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex;
            gap: 5px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-float {
            border: none;
            background: transparent;
            color: #8e8e93;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 20px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-float.active {
            background: #007aff; /* iOS Blue */
            color: white;
            box-shadow: 0 2px 10px rgba(0,122,255,0.3);
        }

        .last-update-text {
            font-size: 0.8rem; color: #8e8e93; text-align: right; margin-bottom: 5px;
        }
    </style>
</head>
<body>

<div class="container dashboard-container">
    <div class="d-flex justify-content-between align-items-end mb-2">
        <div>
            <h1 class="fw-bold text-dark m-0" style="letter-spacing: -1px;">戰情室</h1>
            <p class="text-muted mb-0" style="font-size: 0.9rem;">Market Dashboard</p>
        </div>
        <div class="text-end">
            <div class="last-update-text">Updated</div>
            <div id="last-update" class="fw-bold" style="font-size: 0.9rem;">--</div>
        </div>
    </div>

    <div class="section-title">市場熱度 (Heat)</div>
    <div class="row g-3">
        <div class="col-md-4 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">CNN 恐懼貪婪</span>
                    <span class="status-badge" id="cnn-badge">--</span>
                </div>
                <div class="metric-value" id="cnn-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="cnn-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartCNN"></canvas></div>
            </div>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">台積電 PE</span>
                    <span class="status-badge" id="pe-badge">--</span>
                </div>
                <div class="metric-value" id="pe-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="pe-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartPE"></canvas></div>
            </div>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">景氣燈號</span>
                    <span class="status-badge" id="biz-badge">--</span>
                </div>
                <div class="metric-value" id="biz-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="biz-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartBiz"></canvas></div>
            </div>
        </div>
    </div>

    <div class="section-title">避險與資金 (Risk & Safe Haven)</div>
    <div class="row g-3">
        <div class="col-md-3 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">黃金期貨 (Gold)</span>
                    <span class="status-badge" id="gold-badge">--</span>
                </div>
                <div class="metric-value" id="gold-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="gold-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartGold"></canvas></div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">VIX 恐慌指數</span>
                    <span class="status-badge" id="vix-badge">--</span>
                </div>
                <div class="metric-value" id="vix-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="vix-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartVIX"></canvas></div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">美債 10年殖利率</span>
                    <span class="status-badge" id="bond-badge">--</span>
                </div>
                <div class="metric-value" id="bond-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="bond-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartBond"></canvas></div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">美元/台幣 匯率</span>
                    <span class="status-badge" id="usd-badge">--</span>
                </div>
                <div class="metric-value" id="usd-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="usd-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartUSD"></canvas></div>
            </div>
        </div>
    </div>
</div>

<div class="floating-controls">
    <button class="btn-float active" onclick="updateTimeRange('30d', this)">30天</button>
    <button class="btn-float" onclick="updateTimeRange('90d', this)">90天</button>
    <button class="btn-float" onclick="updateTimeRange('all', this)">全部</button>
</div>

<script>
    let rawData = [];
    let charts = {};
    
    // 顏色定義
    const COLORS = { 
        red: '#ff3b30', orange: '#ff9500', yellow: '#ffcc00', green: '#34c759', 
        blue: '#007aff', grey: '#8e8e93', teal: '#5ac8fa'
    };

    function getProgress(val, type) {
        let pct = 50;
        val = parseFloat(val);
        if (type === 'cnn') pct = val; 
        else if (type === 'pe') pct = (val - 10) / (35 - 10) * 100;
        else if (type === 'biz') pct = (val / 45) * 100;
        else if (type === 'vix') pct = (val - 10) / (40 - 10) * 100;
        else if (type === 'bond') pct = (val - 3.0) / (5.0 - 3.0) * 100;
        else if (type === 'usd') pct = (val - 29) / (33 - 29) * 100;
        else if (type === 'gold') pct = (val - 2000) / (3000 - 2000) * 100;
        return Math.min(100, Math.max(5, pct));
    }

    function getStatus(value, type) {
        val = parseFloat(value);
        if (type === 'cnn') {
            if (val >= 75) return { color: COLORS.red, text: '極度貪婪' };
            if (val <= 25) return { color: COLORS.green, text: '極度恐懼' };
            return { color: COLORS.orange, text: '中立' };
        } 
        if (type === 'pe') {
            if (val >= 25) return { color: COLORS.red, text: '昂貴' };
            if (val <= 15) return { color: COLORS.green, text: '便宜' };
            return { color: COLORS.orange, text: '合理' };
        }
        if (type === 'biz') {
            if (val >= 38) return { color: COLORS.red, text: '紅燈' };
            if (val >= 32) return { color: COLORS.orange, text: '黃紅' };
            if (val <= 23) return { color: COLORS.blue, text: '藍燈' };
            return { color: COLORS.green, text: '綠燈' };
        }
        if (type === 'vix') {
            if (val < 15) return { color: COLORS.red, text: '過度樂觀' };
            if (val > 28) return { color: COLORS.green, text: '恐慌買點' };
            return { color: COLORS.grey, text: '正常' };
        }
        if (type === 'bond') {
            if (val >= 4.4) return { color: COLORS.red, text: '緊縮' };
            return { color: COLORS.grey, text: '中性' };
        }
        if (type === 'usd') {
            if (val >= 32.2) return { color: COLORS.red, text: '外資流出' };
            if (val <= 30.5) return { color: COLORS.green, text: '強勢' };
            return { color: COLORS.teal, text: '盤整' };
        }
        if (type === 'gold') {
            if (val >= 2700) return { color: COLORS.red, text: '創高熱' };
            if (val >= 2500) return { color: COLORS.yellow, text: '強勢' };
            return { color: COLORS.green, text: '回檔' };
        }
        return { color: COLORS.grey, text: 'N/A' };
    }

    function initChart(ctxId, color) {
        return new Chart(document.getElementById(ctxId).getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: color, borderWidth: 2.5, pointRadius: 0, fill: true, backgroundColor: color + '15', tension: 0.4 }]},
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } }, 
                scales: { x: { display: false }, y: { display: false } },
                interaction: { mode: 'index', intersect: false }
            }
        });
    }

    async function loadData() {
        try {
            const res = await fetch('./data/history.json?t=' + Date.now());
            rawData = await res.json();
            rawData.sort((a, b) => new Date(a.date.replace(/-/g, '/')) - new Date(b.date.replace(/-/g, '/')));
            
            updateDashboard(rawData[rawData.length - 1]);
            
            charts.cnn = initChart('chartCNN', COLORS.orange);
            charts.pe = initChart('chartPE', COLORS.red);
            charts.biz = initChart('chartBiz', COLORS.red);
            charts.gold = initChart('chartGold', '#FFD700'); 
            charts.vix = initChart('chartVIX', COLORS.grey);
            charts.bond = initChart('chartBond', '#000');
            charts.usd = initChart('chartUSD', COLORS.blue);

            updateTimeRange('30d', null);
        } catch (e) { document.getElementById('last-update').innerText = "讀取失敗"; console.error(e); }
    }

    function updateDashboard(latest) {
        document.getElementById('last-update').innerText = latest.date.split(" ")[0];
        
        const updateCard = (id, val, type) => {
            const stat = getStatus(val, type);
            const pct = getProgress(val, type);

            const elVal = document.getElementById(id + '-val');
            elVal.innerText = val;
            elVal.style.color = stat.color === '#FFD700' ? '#b58900' : stat.color; 
            
            const elBadge = document.getElementById(id + '-badge');
            elBadge.innerText = stat.text;
            elBadge.style.backgroundColor = stat.color;
            if(stat.color === '#FFD700') elBadge.style.color = '#000'; 

            document.getElementById(id + '-bar').style.width = pct + '%'; 
            document.getElementById(id + '-bar').style.backgroundColor = stat.color;
        };

        updateCard('cnn', latest.cnn_score, 'cnn');
        updateCard('pe', latest.tw_pe, 'pe');
        updateCard('biz', latest.biz_score, 'biz');
        updateCard('gold', latest.gold || 0, 'gold');
        updateCard('vix', latest.vix || 0, 'vix');
        updateCard('bond', latest.us_10y || 0, 'bond');
        updateCard('usd', latest.usd_twd || 0, 'usd');
    }

    window.updateTimeRange = function(range, btn) {
        if (btn) {
            document.querySelectorAll('.btn-float').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        if (!rawData.length) return;
        
        const now = new Date();
        let cutoff = new Date();
        if (range === '30d') cutoff.setDate(now.getDate() - 30);
        else if (range === '90d') cutoff.setDate(now.getDate() - 90);
        else cutoff = new Date('2000-01-01');

        const data = rawData.filter(d => new Date(d.date.replace(/-/g, '/')) >= cutoff);
        const labels = data.map(d => d.date.substring(5, 10));

        const update = (chart, key) => {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data.map(d => d[key] || 0);
            chart.update();
        };

        update(charts.cnn, 'cnn_score');
        update(charts.pe, 'tw_pe');
        update(charts.biz, 'biz_score');
        update(charts.gold, 'gold');
        update(charts.vix, 'vix');
        update(charts.bond, 'us_10y');
        update(charts.usd, 'usd_twd');
    }

    loadData();
</script>

</body>
</html>
