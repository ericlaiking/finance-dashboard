<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŠ•è³‡æ±ºç­–æˆ°æƒ…å®¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --ios-blur: saturate(180%) blur(20px);
            --ios-bg: rgba(255, 255, 255, 0.75);
            --card-radius: 20px;
        }

        body { 
            background-color: #f2f2f7; /* iOS æ·ºç°èƒŒæ™¯ */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 120px; /* é ç•™åº•éƒ¨æ‡¸æµ®ç©ºé–“ */
        }
        
        .dashboard-container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        /* å¡ç‰‡è¨­è¨ˆ */
        .card { 
            border: none; 
            border-radius: var(--card-radius); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
            transition: transform 0.2s; 
            background: white;
            height: 100%;
        }
        .card:active { transform: scale(0.98); }
        
        .metric-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .metric-title { font-size: 0.8rem; color: #8e8e93; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-badge { font-size: 0.7rem; padding: 4px 8px; border-radius: 8px; font-weight: 700; color: white; }
        .metric-value { font-size: 2.2rem; font-weight: 700; line-height: 1.1; margin: 5px 0 15px 0; letter-spacing: -0.5px; color: #1c1c1e; }
        
        .gauge-container { height: 6px; background: #e5e5ea; border-radius: 3px; margin-bottom: 15px; overflow: hidden; }
        .gauge-fill { height: 100%; border-radius: 3px; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1), background-color 0.5s; }
        
        .chart-wrapper { height: 120px; width: 100%; }
        
        .section-title { 
            font-size: 1.3rem; font-weight: 700; color: #1c1c1e; 
            margin: 30px 0 15px 0; letter-spacing: -0.5px;
        }

        /* iOS é¢¨æ ¼æ‡¸æµ®æ§åˆ¶åˆ— (ä¿®æ­£ç‚ºçµ•å°ç½®ä¸­èˆ‡æ¯›ç»ç’ƒæ•ˆæœ) */
        .floating-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: var(--ios-bg);
            backdrop-filter: var(--ios-blur);
            -webkit-backdrop-filter: var(--ios-blur);
            padding: 8px;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex;
            gap: 5px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-float {
            border: none;
            background: transparent;
            color: #8e8e93;
            font-size: 0.9rem;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 20px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-float.active {
            background: #007aff; /* iOS Blue */
            color: white;
            box-shadow: 0 2px 10px rgba(0,122,255,0.3);
        }

        .last-update-text {
            font-size: 0.8rem; color: #8e8e93; text-align: right; margin-bottom: 5px;
        }
    </style>
</head>
<body>

<div class="container dashboard-container">
    <div class="d-flex justify-content-between align-items-end mb-2">
        <div>
            <h1 class="fw-bold text-dark m-0" style="letter-spacing: -1px;">æˆ°æƒ…å®¤</h1>
            <p class="text-muted mb-0" style="font-size: 0.9rem;">Market Dashboard</p>
        </div>
        <div class="text-end">
            <div class="last-update-text">Updated</div>
            <div id="last-update" class="fw-bold" style="font-size: 0.9rem;">--</div>
        </div>
    </div>

    <div class="section-title">å¸‚å ´ç†±åº¦ (Heat)</div>
    <div class="row g-3">
        <div class="col-md-4 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">CNN ææ‡¼è²ªå©ª</span>
                    <span class="status-badge" id="cnn-badge">--</span>
                </div>
                <div class="metric-value" id="cnn-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="cnn-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartCNN"></canvas></div>
            </div>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">å°ç©é›» PE</span>
                    <span class="status-badge" id="pe-badge">--</span>
                </div>
                <div class="metric-value" id="pe-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="pe-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartPE"></canvas></div>
            </div>
        </div>
        <div class="col-md-4 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">æ™¯æ°£ç‡ˆè™Ÿ</span>
                    <span class="status-badge" id="biz-badge">--</span>
                </div>
                <div class="metric-value" id="biz-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="biz-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartBiz"></canvas></div>
            </div>
        </div>
    </div>

    <div class="section-title">é¿éšªèˆ‡è³‡é‡‘ (Risk & Safe Haven)</div>
    <div class="row g-3">
        <div class="col-md-3 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">é»ƒé‡‘æœŸè²¨ (Gold)</span>
                    <span class="status-badge" id="gold-badge">--</span>
                </div>
                <div class="metric-value" id="gold-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="gold-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartGold"></canvas></div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">VIX ææ…ŒæŒ‡æ•¸</span>
                    <span class="status-badge" id="vix-badge">--</span>
                </div>
                <div class="metric-value" id="vix-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="vix-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartVIX"></canvas></div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">ç¾å‚µ 10å¹´æ®–åˆ©ç‡</span>
                    <span class="status-badge" id="bond-badge">--</span>
                </div>
                <div class="metric-value" id="bond-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="bond-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartBond"></canvas></div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6">
            <div class="card p-3">
                <div class="metric-header">
                    <span class="metric-title">ç¾å…ƒ/å°å¹£ åŒ¯ç‡</span>
                    <span class="status-badge" id="usd-badge">--</span>
                </div>
                <div class="metric-value" id="usd-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="usd-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartUSD"></canvas></div>
            </div>
        </div>
    </div>
</div>

<div class="floating-controls">
    <button class="btn-float active" onclick="updateTimeRange('30d', this)">30å¤©</button>
    <button class="btn-float" onclick="updateTimeRange('90d', this)">90å¤©</button>
    <button class="btn-float" onclick="updateTimeRange('all', this)">å…¨éƒ¨</button>
</div>

<script>
    let rawData = [];
    let charts = {};
    let currentRange = '30d';
    
    // é¡è‰²å®šç¾© (èªæ„åŒ–é¡è‰²)
    const COLORS = { 
        red: '#ff3b30',     // æ¥µåº¦è²ªå©ª / éç†± / å±éšª
        orange: '#ff9500',  // è²ªå©ª / åé«˜ / è­¦å‘Š
        grey: '#8e8e93',    // ä¸­ç«‹ / åˆç† / æ­£å¸¸
        blue: '#007aff',    // ææ‡¼ / åå†· / é—œæ³¨
        green: '#34c759',   // æ¥µåº¦ææ‡¼ / ä¾¿å®œ / è²·é»
        yellow: '#ffcc00'   // é»ƒé‡‘å°ˆç”¨
    };

    // 1. é€²åº¦æ¢è¨ˆç®— (Linear Mapping)
    // å°‡æ•¸å€¼æ˜ å°„åˆ° 0% ~ 100% çš„é•·åº¦ï¼Œé¿å…ç ´è¡¨
    function getProgress(val, type) {
        let pct = 50;
        val = parseFloat(val);
        
        if (type === 'cnn') {
            pct = val; // 0-100 ç›´æ¥å°æ‡‰
        } 
        else if (type === 'pe') {
            // PE å€é–“: 10(0%) ~ 35(100%)
            pct = (val - 10) / (35 - 10) * 100;
        }
        else if (type === 'biz') {
            // ç‡ˆè™Ÿåˆ†æ•¸: 9(0%) ~ 45(100%)
            pct = (val - 9) / (45 - 9) * 100;
        }
        else if (type === 'vix') {
            // VIX: 10(0%) ~ 40(100%)
            pct = (val - 10) / (40 - 10) * 100;
        }
        else if (type === 'bond') {
            // æ®–åˆ©ç‡: 3.0(0%) ~ 5.0(100%)
            pct = (val - 3.0) / (5.0 - 3.0) * 100;
        }
        else if (type === 'usd') {
            // åŒ¯ç‡: 29(0%) ~ 33(100%)
            pct = (val - 29) / (33 - 29) * 100;
        }
        else if (type === 'gold') {
            // é»ƒé‡‘: 2000(0%) ~ 3000(100%)
            pct = (val - 2000) / (3000 - 2000) * 100;
        }
        
        return Math.min(100, Math.max(0, pct));
    }

    // 2. ç‹€æ…‹åˆ¤è®€ (æ ¸å¿ƒé‚è¼¯ä¿®æ­£å€)
    function getStatus(value, type) {
        val = parseFloat(value);
        
        // --- A. CNN ææ‡¼è²ªå©ª (åƒç…§åœ–ç‰‡å®šç¾©) ---
        if (type === 'cnn') {
            if (val >= 75) return { color: COLORS.red, text: 'æ¥µåº¦è²ªå©ª' };
            if (val >= 56) return { color: COLORS.orange, text: 'è²ªå©ª' };
            if (val >= 45) return { color: COLORS.grey, text: 'ä¸­ç«‹' };
            if (val >= 26) return { color: COLORS.blue, text: 'ææ‡¼' };
            return { color: COLORS.green, text: 'æ¥µåº¦ææ‡¼' };
        } 
        
        // --- B. å°ç©é›» PE (AI æ™‚ä»£ä¼°å€¼ä¿®æ­£) ---
        if (type === 'pe') {
            if (val >= 28) return { color: COLORS.red, text: 'æ˜‚è²´' };
            if (val >= 23) return { color: COLORS.orange, text: 'åé«˜' }; // ç›®å‰ 27.x åœ¨æ­¤
            if (val >= 18) return { color: COLORS.grey, text: 'åˆç†' };
            return { color: COLORS.green, text: 'ä¾¿å®œ' };
        }
        
        // --- C. æ™¯æ°£ç‡ˆè™Ÿ (åœ‹ç™¼æœƒå®˜æ–¹å®šç¾©) ---
        if (type === 'biz') {
            if (val >= 38) return { color: COLORS.red, text: 'ç´…ç‡ˆ' };
            if (val >= 32) return { color: COLORS.orange, text: 'é»ƒç´…ç‡ˆ' };
            if (val >= 23) return { color: COLORS.green, text: 'ç¶ ç‡ˆ' }; // é€™è£¡ç”¨ç¶ è‰²ä»£è¡¨ç©©å®š/å®‰å…¨
            if (val >= 17) return { color: COLORS.blue, text: 'é»ƒè—ç‡ˆ' };
            return { color: COLORS.blue, text: 'è—ç‡ˆ' }; // è—ç‡ˆä¹Ÿæ˜¯ä¸€ç¨®è²·é»ä¿¡è™Ÿ
        }
        
        // --- D. VIX (è¯çˆ¾è¡—æ¨™æº–) ---
        if (type === 'vix') {
            if (val < 15) return { color: COLORS.red, text: 'éåº¦æ¨‚è§€' }; // å±éšª
            if (val <= 20) return { color: COLORS.grey, text: 'æ­£å¸¸' };
            if (val <= 30) return { color: COLORS.orange, text: 'è­¦æˆ’' };
            return { color: COLORS.green, text: 'ææ…Œ(è²·)' };
        }
        
        // --- E. ç¾å‚µæ®–åˆ©ç‡ (é€šè†¨æ™‚ä»£æ¨™æº–) ---
        if (type === 'bond') {
            if (val >= 4.5) return { color: COLORS.red, text: 'ç·Šç¸®å£“åŠ›' };
            if (val >= 4.0) return { color: COLORS.orange, text: 'é«˜æª”éœ‡ç›ª' };
            return { color: COLORS.grey, text: 'ä¸­æ€§' };
        }
        
        // --- F. åŒ¯ç‡ (32.5 é˜²ç·š) ---
        if (type === 'usd') {
            if (val >= 32.5) return { color: COLORS.red, text: 'å¤–è³‡æµå‡º' };
            if (val >= 31.5) return { color: COLORS.orange, text: 'åå¼±' };
            if (val >= 30.5) return { color: COLORS.grey, text: 'ç›¤æ•´' };
            return { color: COLORS.green, text: 'å¼·å‹¢' };
        }
        
        // --- G. é»ƒé‡‘ ---
        if (type === 'gold') {
            if (val >= 2800) return { color: COLORS.red, text: 'éç†±' };
            if (val >= 2600) return { color: COLORS.yellow, text: 'å¼·å‹¢' };
            return { color: COLORS.grey, text: 'ç›¤æ•´' };
        }
        
        return { color: COLORS.grey, text: 'N/A' };
    }

    function initChart(ctxId, color) {
        return new Chart(document.getElementById(ctxId).getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: color, borderWidth: 2.5, pointRadius: 0, fill: true, backgroundColor: color + '15', tension: 0.4 }]},
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } }, 
                scales: { x: { display: false }, y: { display: false } },
                interaction: { mode: 'index', intersect: false }
            }
        });
    }

    // è³‡æ–™æ¸…æ´—ï¼šæ¯æ—¥ä¸€ç­† (è§£æ±º X è»¸å¯¬åº¦ä¸ä¸€å•é¡Œ)
    function processDailyData(data) {
        const dailyMap = {};
        data.forEach(item => {
            const dateKey = item.date.split(" ")[0]; 
            dailyMap[dateKey] = item;
        });
        return Object.values(dailyMap);
    }

    async function loadData() {
        try {
            const res = await fetch('./data/history.json?t=' + Date.now());
            let fullData = await res.json();
            
            // æ’åº
            fullData.sort((a, b) => new Date(a.date.replace(/-/g, '/')) - new Date(b.date.replace(/-/g, '/')));
            
            // é¡¯ç¤ºæœ€æ–°æ•¸æ“š
            updateDashboard(fullData[fullData.length - 1]);
            
            // åœ–è¡¨ä½¿ç”¨æ¯æ—¥ä¸€ç­†çš„è³‡æ–™
            rawData = processDailyData(fullData);

            // åˆå§‹åŒ–åœ–è¡¨
            charts.cnn = initChart('chartCNN', COLORS.orange);
            charts.pe = initChart('chartPE', COLORS.red);
            charts.biz = initChart('chartBiz', COLORS.red);
            charts.gold = initChart('chartGold', '#FFD700'); 
            charts.vix = initChart('chartVIX', COLORS.grey);
            charts.bond = initChart('chartBond', '#000');
            charts.usd = initChart('chartUSD', COLORS.blue);

            updateTimeRange('30d', null);
        } catch (e) { document.getElementById('last-update').innerText = "è®€å–å¤±æ•—"; console.error(e); }
    }

    function updateDashboard(latest) {
        document.getElementById('last-update').innerText = latest.date;
        
        const updateCard = (id, val, type) => {
            const stat = getStatus(val, type);
            const pct = getProgress(val, type);

            const elVal = document.getElementById(id + '-val');
            elVal.innerText = val;
            
            // é¡è‰²é‚è¼¯å„ªåŒ–
            let textColor = stat.color;
            if (stat.color === '#FFD700') textColor = '#b58900'; // é»ƒé‡‘æ·±è‰²å­—
            elVal.style.color = textColor;
            
            const elBadge = document.getElementById(id + '-badge');
            elBadge.innerText = stat.text;
            elBadge.style.backgroundColor = stat.color;
            
            // Badge æ–‡å­—é¡è‰²
            if(stat.color === '#FFD700' || stat.color === '#e5e5ea') elBadge.style.color = '#000'; 
            else elBadge.style.color = '#fff';

            document.getElementById(id + '-bar').style.width = pct + '%'; 
            document.getElementById(id + '-bar').style.backgroundColor = stat.color;
        };

        updateCard('cnn', latest.cnn_score, 'cnn');
        updateCard('pe', latest.tw_pe, 'pe');
        updateCard('biz', latest.biz_score, 'biz');
        updateCard('gold', latest.gold || 0, 'gold');
        updateCard('vix', latest.vix || 0, 'vix');
        updateCard('bond', latest.us_10y || 0, 'bond');
        updateCard('usd', latest.usd_twd || 0, 'usd');
    }

    window.updateTimeRange = function(range, btn) {
        currentRange = range;
        if (btn) {
            document.querySelectorAll('.btn-float').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        if (!rawData.length) return;
        
        const now = new Date();
        let cutoff = new Date();
        if (range === '30d') cutoff.setDate(now.getDate() - 30);
        else if (range === '90d') cutoff.setDate(now.getDate() - 90);
        else cutoff = new Date('2000-01-01');

        const data = rawData.filter(d => new Date(d.date.replace(/-/g, '/')) >= cutoff);
        const labels = data.map(d => d.date.substring(5, 10));

        const update = (chart, key) => {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data.map(d => d[key] || 0);
            chart.update();
        };

        update(charts.cnn, 'cnn_score');
        update(charts.pe, 'tw_pe');
        update(charts.biz, 'biz_score');
        update(charts.gold, 'gold');
        update(charts.vix, 'vix');
        update(charts.bond, 'us_10y');
        update(charts.usd, 'usd_twd');
    }

    loadData();

// ==========================================
    // ğŸ”„ è‡ªå‹•æ›´æ–°æ©Ÿåˆ¶ (Auto-Refresh Logic)
    // ==========================================
    
    async function checkForUpdates() {
        // console.log("ğŸ” Checking for updates..."); // å¯ä»¥è¨»è§£æ‰é¿å…æ´—ç‰ˆ
        try {
            const res = await fetch('./data/history.json?t=' + Date.now());
            const fetchedData = await res.json();
            
            // 1. å…ˆå°æ–°è³‡æ–™é€²è¡Œæ’åºï¼Œç¢ºä¿æœ€å¾Œä¸€ç­†çœŸçš„æ˜¯æœ€æ–°çš„
            fetchedData.sort((a, b) => new Date(a.date.replace(/-/g, '/')) - new Date(b.date.replace(/-/g, '/')));
            
            // 2. å–å‡ºé›™æ–¹çš„ã€Œæœ€å¾Œä¸€ç­†è³‡æ–™ã€ä¾†æ¯”å°
            const newLatest = fetchedData[fetchedData.length - 1];
            const currentLatest = rawData[rawData.length - 1];

            // 3. æ ¸å¿ƒä¿®æ­£ï¼šåªæ¯”å°ã€Œæ—¥æœŸæ™‚é–“å­—ä¸²ã€æ˜¯å¦ä¸åŒ
            // å¦‚æœæ–°æŠ“åˆ°çš„æ™‚é–“ (ä¾‹å¦‚ 14:00) è·Ÿç¾åœ¨é¡¯ç¤ºçš„æ™‚é–“ (ä¾‹å¦‚ 13:00) ä¸ä¸€æ¨£ï¼Œæ‰æ›´æ–°
            if (newLatest.date !== currentLatest.date) {
                
                console.log(`ğŸš€ New data found! (${currentLatest.date} -> ${newLatest.date})`);
                
                // æ›´æ–°å…¨åŸŸè³‡æ–™
                rawData = processDailyData(fetchedData); 
                
                // å†æ¬¡æ’åº (æ¸…æ´—å¾Œç¢ºä¿é †åº)
                rawData.sort((a, b) => new Date(a.date.replace(/-/g, '/')) - new Date(b.date.replace(/-/g, '/')));
                
                // æ›´æ–°ç•«é¢
                updateDashboard(rawData[rawData.length - 1]);
                updateTimeRange(currentRange, null);
                
                // è¦–è¦ºæç¤º
                const timeLabel = document.getElementById('last-update');
                timeLabel.style.color = '#34c759'; 
                timeLabel.innerText = "Updated just now!";
                setTimeout(() => {
                    timeLabel.style.color = ''; 
                    timeLabel.innerText = rawData[rawData.length - 1].date;
                }, 3000);
            } 
            // else { console.log("ğŸ’¤ No new data."); }
        } catch (e) {
            console.error("Auto-refresh failed:", e);
        }
    }

    // å•Ÿå‹•å®šæ™‚å™¨ï¼šæ¯ 60 ç§’æª¢æŸ¥ä¸€æ¬¡
    // (GitHub Pages CDN æœ‰å¿«å–å»¶é²ï¼Œè¨­å¤ªå¿«ä¹Ÿæ²’ç”¨ï¼Œ60ç§’å‰›å¥½)
    setInterval(checkForUpdates, 60000);
    
</script>

</body>
</html>
