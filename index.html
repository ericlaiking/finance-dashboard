<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½å¸‚å ´å„€è¡¨æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .dashboard-container { max-width: 1200px; margin: 30px auto; }
        
        .card { 
            border: none; border-radius: 16px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            transition: all 0.3s ease; height: 100%; 
            background: white;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        
        /* æ¨™é¡Œèˆ‡æ¨™ç±¤ */
        .metric-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .metric-title { font-size: 0.85rem; color: #6c757d; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* ç‹€æ…‹æ¨™ç±¤ (Badge) */
        .status-badge {
            font-size: 0.75rem; padding: 4px 10px; border-radius: 12px;
            font-weight: 600; color: white; background-color: #adb5bd;
        }

        /* æ•¸å€¼é¡¯ç¤º */
        .metric-value { font-size: 2.8rem; font-weight: 800; line-height: 1; margin: 10px 0; letter-spacing: -1px;}
        
        /* é€²åº¦æ¢å®¹å™¨ */
        .gauge-container { 
            height: 10px; background: #e9ecef; border-radius: 5px; margin-bottom: 15px; overflow: hidden; position: relative;
        }
        /* é€²åº¦æ¢æœ¬é«” */
        .gauge-fill { height: 100%; border-radius: 5px; transition: width 1s ease-in-out, background-color 0.5s; }
        
        .chart-wrapper { height: 140px; width: 100%; }
        
        .section-title { 
            font-size: 1.1rem; font-weight: 800; color: #344767; 
            margin: 30px 0 15px 0; border-left: 4px solid #344767; padding-left: 12px; 
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .chart-controls { display: flex; justify-content: flex-end; gap: 5px; margin-bottom: 10px; }
        .btn-time { font-size: 0.7rem; padding: 3px 12px; border-radius: 20px; border: 1px solid #dee2e6; background: white; color: #6c757d; font-weight: 600; }
        .btn-time.active { background: #344767; color: white; border-color: #344767; }
    </style>
</head>
<body>

<div class="container dashboard-container">
    <div class="d-flex justify-content-between align-items-end mb-4">
        <div>
            <h2 class="fw-bold text-dark" style="letter-spacing: -0.5px;">ğŸš€ æŠ•è³‡æ±ºç­–æˆ°æƒ…å®¤</h2>
            <p class="text-muted mb-0">Market Sentiment & Risk Dashboard</p>
        </div>
        <div class="text-end">
            <small class="text-muted d-block">Last Updated</small>
            <span id="last-update" class="fw-bold text-primary">è¼‰å…¥ä¸­...</span>
        </div>
    </div>

    <div class="section-title">ğŸ”¥ å¸‚å ´ç†±åº¦ (Market Heat)</div>
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">CNN ææ‡¼è²ªå©ª</span>
                    <span class="status-badge" id="cnn-badge">--</span>
                </div>
                <div class="metric-value" id="cnn-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="cnn-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartCNN"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">å°ç©é›» æœ¬ç›Šæ¯”</span>
                    <span class="status-badge" id="pe-badge">--</span>
                </div>
                <div class="metric-value" id="pe-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="pe-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartPE"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">æ™¯æ°£å°ç­–ä¿¡è™Ÿ</span>
                    <span class="status-badge" id="biz-badge">--</span>
                </div>
                <div class="metric-value" id="biz-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="biz-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartBiz"></canvas></div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
        <div class="section-title m-0">ğŸŒŠ é¢¨éšªèˆ‡è³‡é‡‘ (Risk & Flow)</div>
        <div class="chart-controls">
            <button class="btn btn-time active" onclick="updateTimeRange('30d', this)">30å¤©</button>
            <button class="btn btn-time" onclick="updateTimeRange('90d', this)">90å¤©</button>
            <button class="btn btn-time" onclick="updateTimeRange('all', this)">å…¨éƒ¨</button>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">VIX ææ…ŒæŒ‡æ•¸</span>
                    <span class="status-badge" id="vix-badge">--</span>
                </div>
                <div class="metric-value" id="vix-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="vix-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartVIX"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">ç¾åœ‹ 10å¹´å‚µæ®–åˆ©ç‡</span>
                    <span class="status-badge" id="bond-badge">--</span>
                </div>
                <div class="metric-value" id="bond-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="bond-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartBond"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card p-4">
                <div class="metric-header">
                    <span class="metric-title">ç¾å…ƒ/å°å¹£ åŒ¯ç‡</span>
                    <span class="status-badge" id="usd-badge">--</span>
                </div>
                <div class="metric-value" id="usd-val">--</div>
                <div class="gauge-container"><div class="gauge-fill" id="usd-bar" style="width: 0%"></div></div>
                <div class="chart-wrapper"><canvas id="chartUSD"></canvas></div>
            </div>
        </div>
    </div>
</div>

<script>
    let rawData = [];
    let charts = {};
    // é¡è‰²å®šç¾©ï¼šç´…(å±éšª/ç†±), æ©˜(è­¦å‘Š), ç°(ä¸­ç«‹), è—(å†·), ç¶ (å®‰å…¨/ä¾¿å®œ)
    const COLORS = { 
        danger: '#dc3545', // ç´… (å±éšª/éç†±/å¤–è³‡æµå‡º)
        warning: '#ffc107', // é»ƒ (è­¦å‘Š)
        neutral: '#adb5bd', // ç° (ä¸­ç«‹)
        safe: '#198754',    // ç¶  (å®‰å…¨/ä¾¿å®œ/ææ…Œè²·é»)
        info: '#0dcaf0'     // è— (åå†·)
    };

    // 1. è¨ˆç®—é€²åº¦æ¢ç™¾åˆ†æ¯” (æ±ºå®š Bar çš„é•·åº¦)
    function getProgress(val, type) {
        let pct = 0;
        val = parseFloat(val);
        
        if (type === 'cnn') pct = val; 
        else if (type === 'pe') pct = (val - 10) / (35 - 10) * 100; // 10~35
        else if (type === 'biz') pct = (val / 45) * 100; // 0~45
        else if (type === 'vix') pct = (val - 10) / (40 - 10) * 100; // 10~40
        else if (type === 'bond') pct = (val - 3.0) / (5.0 - 3.0) * 100; // 3.0% ~ 5.0%
        else if (type === 'usd') pct = (val - 29) / (33 - 29) * 100; // 29 ~ 33
        
        return Math.min(100, Math.max(5, pct));
    }

    // 2. åˆ¤è®€é‚è¼¯ (æ±ºå®šé¡è‰²èˆ‡æ–‡å­—) - é€™æ˜¯å„€è¡¨æ¿çš„ã€Œå¤§è…¦ã€
    function getStatus(value, type) {
        val = parseFloat(value);

        if (type === 'cnn') {
            if (val >= 75) return { color: COLORS.danger, text: 'ğŸ”¥ æ¥µåº¦è²ªå©ª' };
            if (val <= 25) return { color: COLORS.safe, text: 'ğŸ¥¶ æ¥µåº¦ææ‡¼' };
            return { color: COLORS.warning, text: 'ğŸ˜ ä¸­ç«‹è§€æœ›' };
        } 
        
        if (type === 'pe') {
            if (val >= 25) return { color: COLORS.danger, text: 'âš ï¸ ä¼°å€¼éé«˜' };
            if (val <= 15) return { color: COLORS.safe, text: 'ğŸ’° ä¼°å€¼ä¾¿å®œ' };
            return { color: COLORS.warning, text: 'ğŸ‘Œ ä¼°å€¼åˆç†' };
        }
        
        if (type === 'biz') {
            // é€™è£¡å¼·åˆ¶ä¿®æ­£ï¼š38åˆ†ä»¥ä¸Šå°±æ˜¯ç´…ç‡ˆéç†±
            if (val >= 38) return { color: COLORS.danger, text: 'ğŸ”¥ ç´…ç‡ˆéç†±' };
            if (val >= 32) return { color: COLORS.warning, text: 'ğŸŸ¡ é»ƒç´…ç‡ˆ' };
            if (val <= 23) return { color: COLORS.info, text: 'ğŸ”µ è—ç‡ˆä½è¿·' };
            return { color: COLORS.safe, text: 'ğŸŸ¢ ç¶ ç‡ˆç©©å®š' };
        }
        
        if (type === 'vix') {
            // VIX ä½ = å¸‚å ´å¤ªæ¨‚è§€ = å±éšª
            if (val < 15) return { color: COLORS.danger, text: 'âš ï¸ éåº¦æ¨‚è§€' };
            if (val > 28) return { color: COLORS.safe, text: 'ğŸ’ ææ…Œè²·é»' };
            return { color: COLORS.neutral, text: 'âš–ï¸ æ³¢å‹•æ­£å¸¸' };
        }
        
        if (type === 'bond') {
            if (val >= 4.2) return { color: COLORS.danger, text: 'âš ï¸ è³‡é‡‘ç·Šç¸®' };
            if (val <= 3.5) return { color: COLORS.safe, text: 'ğŸ’¸ è³‡é‡‘å¯¬é¬†' };
            return { color: COLORS.neutral, text: 'âš–ï¸ åˆ©ç‡ä¸­æ€§' };
        }
        
        if (type === 'usd') {
            if (val >= 32.2) return { color: COLORS.danger, text: 'ğŸ“¤ å¤–è³‡æµå‡º' };
            if (val <= 30.5) return { color: COLORS.safe, text: 'ğŸ“¥ å¤–è³‡åŒ¯å…¥' };
            return { color: COLORS.neutral, text: 'âš–ï¸ åŒ¯ç‡ç›¤æ•´' };
        }
        
        return { color: COLORS.neutral, text: 'N/A' };
    }

    function initChart(ctxId, color) {
        return new Chart(document.getElementById(ctxId).getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: color, borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: color + '10', tension: 0.4 }]},
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { position: 'right', grid: { display: false } } } }
        });
    }

    async function loadData() {
        try {
            const res = await fetch('./data/history.json?t=' + Date.now());
            rawData = await res.json();
            // æ—¥æœŸæ’åº
            rawData.sort((a, b) => new Date(a.date.replace(/-/g, '/')) - new Date(b.date.replace(/-/g, '/')));
            
            updateDashboard(rawData[rawData.length - 1]);
            
            // åˆå§‹åŒ–åœ–è¡¨ (é¡è‰²çµ¦é è¨­ï¼Œå¾Œé¢ updateTimeRange æœƒé‡ç¹ª)
            charts.cnn = initChart('chartCNN', COLORS.warning);
            charts.pe = initChart('chartPE', COLORS.danger);
            charts.biz = initChart('chartBiz', COLORS.danger);
            charts.vix = initChart('chartVIX', COLORS.neutral);
            charts.bond = initChart('chartBond', '#333');
            charts.usd = initChart('chartUSD', COLORS.info);

            updateTimeRange('30d', null);
        } catch (e) { document.getElementById('last-update').innerText = "è®€å–å¤±æ•—"; console.error(e); }
    }

    function updateDashboard(latest) {
        document.getElementById('last-update').innerText = latest.date;
        
        const updateCard = (id, val, type) => {
            const stat = getStatus(val, type);
            const pct = getProgress(val, type);

            // æ›´æ–°æ•¸å€¼é¡è‰²
            const elVal = document.getElementById(id + '-val');
            elVal.innerText = val;
            elVal.style.color = stat.color;
            
            // æ›´æ–° Badge (èƒŒæ™¯è‰² + æ–‡å­—)
            const elBadge = document.getElementById(id + '-badge');
            elBadge.innerText = stat.text;
            elBadge.style.backgroundColor = stat.color;

            // æ›´æ–°é€²åº¦æ¢
            document.getElementById(id + '-bar').style.width = pct + '%'; 
            document.getElementById(id + '-bar').style.backgroundColor = stat.color;
        };

        updateCard('cnn', latest.cnn_score, 'cnn');
        updateCard('pe', latest.tw_pe, 'pe');
        updateCard('biz', latest.biz_score, 'biz');
        updateCard('vix', latest.vix || 0, 'vix');
        updateCard('bond', latest.us_10y || 0, 'bond');
        updateCard('usd', latest.usd_twd || 0, 'usd');
    }

    window.updateTimeRange = function(range, btn) {
        if (btn) {
            document.querySelectorAll('.btn-time').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        if (!rawData.length) return;
        
        const now = new Date();
        let cutoff = new Date();
        if (range === '30d') cutoff.setDate(now.getDate() - 30);
        else if (range === '90d') cutoff.setDate(now.getDate() - 90);
        else cutoff = new Date('2000-01-01');

        const data = rawData.filter(d => new Date(d.date.replace(/-/g, '/')) >= cutoff);
        const labels = data.map(d => d.date.substring(5, 10));

        const update = (chart, key) => {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data.map(d => d[key] || 0);
            chart.update();
        };

        update(charts.cnn, 'cnn_score');
        update(charts.pe, 'tw_pe');
        update(charts.biz, 'biz_score');
        update(charts.vix, 'vix');
        update(charts.bond, 'us_10y');
        update(charts.usd, 'usd_twd');
    }

    loadData();
</script>

</body>
</html>
